<ng-container *ngIf="!loader">
  <app-navigation [user]="user" (changePasswordEmitter)="openChangePassword()">
  </app-navigation>

  <ng-container *ngIf="!identifyDevice()">
    <div
      class="site-page"
      [class.mobile-device]="isMobileDevice"
      *ngIf="pageData && !dashboard"
      [ngSwitch]="pageData.pathData.type"
    >
      <div
        *ngSwitchCase="'form'"
        class="form-page"
        [class.profile-page]="isProfilePage(pageData)"
      >
        <ng-container
          *ngIf="
            listName &&
            !(
              pageData.pathData.postfix &&
              pageData.pathData.postfix === 'fillin'
            ) &&
            !isProfilePage(pageData)
          "
        >
          <webui-back-link
            [label]="this.backToListLabel"
            [path]="pageData.pathData.path"
          >
          </webui-back-link>
        </ng-container>

        <div
          class="form-content"
          [class.timesheet-submit-form]="pageData.pathData.postfix === 'submit'"
          *ngIf="
            (!reload &&
              !(
                pageData.endpoint === '/acceptance-tests/acceptancetests/' &&
                pageData.pathData.id
              ) &&
              pageData.endpoint !== '/core/forms/') ||
            pageData.pathData.postfix === 'submit'
          "
        >
          <webui-generic-form
            *ngIf="
              (!reload &&
                pageData.endpoint !== '/core/forms/' &&
                !pageData.pathData.postfix) ||
              pageData.pathData.postfix === 'submit'
            "
            [title]="
              pageData.pathData.postfix === 'submit'
                ? 'submit_timesheet'
                : ''
            "
            [endpoint]="pageData.endpoint"
            [id]="pageData.pathData.id"
            [edit]="pageData.pathData.postfix"
            [mode]="formMode"
            [errors]="errors"
            [data]="additionalData"
            [path]="pageData.pathData.path"
            [metadataQuery]="pageData.pathData.metadataQuery"
            (event)="formEvent($event)"
            (modeEvent)="modeEvent($event)"
            (errorForm)="formError($event)"
            (permissionError)="permissionErrorHandler($event)"
            (str)="changeFormLabel($event)"
          >
            <div class="d-flex">
              <button
                type="button"
                webuiSubscriptionRequired
                class="btn button-delete custom-button"
                *ngIf="showDeleteButton()"
                (click)="deleteElement(pageData)"
              >
                <fa-icon [icon]="['fas', 'trash']"></fa-icon>
                {{ 'delete' | translate }}
              </button>

              <button
                type="button"
                webuiSubscriptionRequired
                class="btn button-close mt-2"
                *ngIf="formMode === FormMode.Edit"
                (click)="changeMode(FormMode.View)"
              >
                Close without save
              </button>

              <button
                type="button"
                webuiSubscriptionRequired
                class="btn btn-primary btn-shadow ml-auto button-edit"
                *ngIf="formMode === FormMode.View && checkPermission('update')"
                (click)="changeMode(FormMode.Edit)"
              >
                <fa-icon [icon]="['fas', 'pencil-alt']"></fa-icon>
                Edit mode
              </button>

              <button
                type="submit"
                webuiSubscriptionRequired
                class="btn btn-primary button-save save mt-2"
                *ngIf="
                  !formStorage &&
                  formMode !== FormMode.View &&
                  (checkPermission('post') || checkPermission('update')) &&
                  pageData.endpoint !== '/core/users/'
                "
                [disabled]="saveProcess"
              >
                Save
                <webui-spinner *ngIf="saveProcess"></webui-spinner>
              </button>

              <button
                type="button"
                webuiSubscriptionRequired
                class="btn btn-success mr-2 ml-auto"
                *ngIf="
                  formStorage &&
                  !approvedStorage &&
                  formMode === FormMode.Edit &&
                  checkPermission('post')
                "
                (click)="approveFormStorage(pageData)"
              >
                Approve
              </button>
            </div>
          </webui-generic-form>
        </div>
        <div class="form-content" *ngIf="pageData.endpoint === '/core/forms/'">
          <app-form-builder
            [path]="pageData.pathData.path"
            [endpoint]="pageData.endpoint"
            [id]="pageData.pathData.id"
            (str)="changeFormLabel($event)"
          >
          </app-form-builder>
        </div>

        <div
          class="form-content"
          *ngIf="
            !reload &&
            (pageData.endpoint === '/acceptance-tests/acceptancetests/' &&
              pageData.pathData.id)
          "
        >
          <app-test-builder [testData]="acceptenceTestData">
            <webui-generic-form
              [endpoint]="pageData.endpoint"
              [id]="pageData.pathData.id"
              [path]="pageData.pathData.path"
              [mode]="formMode"
              (modeEvent)="modeEvent($event)"
              (errorForm)="formError($event)"
              (event)="formEvent($event)"
              (str)="setTestData($event)"
            >
              <div class="d-flex">
                <button
                  type="button"
                  webuiSubscriptionRequired
                  class="btn button-delete custom-button"
                  *ngIf="pageData.pathData.id && checkPermission('delete')"
                  (click)="deleteElement(pageData)"
                >
                  <fa-icon [icon]="['fas', 'trash']"></fa-icon>
                  {{ 'delete' | translate }}
                </button>

                <button
                  type="button"
                  class="btn button-close"
                  *ngIf="formMode === FormMode.Edit"
                  (click)="changeMode(FormMode.View)"
                >
                  Close without save
                </button>

                <button
                  type="button"
                  webuiSubscriptionRequired
                  class="btn btn-primary btn-shadow ml-auto button-edit"
                  *ngIf="
                    formMode === FormMode.View && checkPermission('update')
                  "
                  (click)="changeMode(FormMode.Edit)"
                >
                  <fa-icon [icon]="['fas', 'pencil-alt']"></fa-icon>
                  Edit mode
                </button>

                <button
                  type="submit"
                  webuiSubscriptionRequired
                  class="btn btn-primary button-save"
                  *ngIf="
                    !formStorage &&
                    formMode !== FormMode.View &&
                    (checkPermission('post') || checkPermission('update'))
                  "
                  [disabled]="saveProcess"
                >
                  Save
                  <webui-spinner *ngIf="saveProcess"></webui-spinner>
                </button>
              </div>
            </webui-generic-form>
          </app-test-builder>
        </div>
      </div>

      <ng-container *ngSwitchCase="'list'">
        <div
          class="datatable-list"
          *ngIf="!pageData.pathData.postfix"
          infinite-scroll
          [scrollWindow]="true"
          (scrolled)="onModalScrollDown()"
        >
          <webui-generic-list
            [upload]="upload"
            [clientId]="getClientId()"
            [listNameCache]="listNameCache"
            [allowPermissions]="permissionMethods"
            [endpoint]="pageData.endpoint"
          >
          </webui-generic-list>
        </div>

        <div
          class="datatable-list"
          *ngIf="
            pageData.pathData.postfix && pageData.pathData.postfix === 'fillin'
          "
        >
          <webui-generic-list
            [responseField]="fillInData.responseField || 'results'"
            [paginated]="fillInData.paginated || 'on'"
            [supportData]="fillInData.supportData"
            [metaType]="fillInData.metaType"
            [actions]="fillInData.actions"
            [clientId]="getClientId()"
            [listNameCache]="listNameCache"
            [allowPermissions]="permissionMethods"
            [endpoint]="pageData.endpoint"
            (checkedObjects)="checkedObjects($event)"
            (listUpdated)="data = null"
          >
            <webui-back-link label="Back to job info" (backEvent)="back()">
            </webui-back-link>
          </webui-generic-list>
          <div class="buttons mb-5">
            <button type="button" class="btn btn-secondary" (click)="back()">
              Cancel
            </button>
            <button
              type="button"
              webuiSubscriptionRequired
              class="btn btn-primary pr-3"
              [disabled]="!data || fillInDataSending"
              (click)="sendData()"
            >
              Fill in
              <webui-spinner *ngIf="fillInDataSending"></webui-spinner>
            </button>
          </div>
        </div>
      </ng-container>

      <app-map *ngSwitchCase="'map'"></app-map>
    </div>
  </ng-container>

  <div class="dashboard" *ngIf="dashboard">
    <webui-dashboard></webui-dashboard>
  </div>

  <webui-mobile-timesheets
    [clientId]="getClientId()"
    *ngIf="identifyDevice()"
  ></webui-mobile-timesheets>

  <ng-template #modal let-modal>
    <div class="modal-content-wrapper">
      <div class="modal-header-wrapper">
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>

          <webui-close-button
            class="ml-auto"
            (click)="modal.dismiss()"
          ></webui-close-button>
        </div>
      </div>
      <div class="py-3">
        <webui-generic-form
          [endpoint]="changePasswordEndpoint"
          [edit]="true"
          [needData]="false"
          (event)="resetEvent($event)"
        >
          <a class="forgot" href="" (click)="openResetForm()"
            >Forgot Password?</a
          >
          <div class="d-flex align-items-center">
            <button webuiSubscriptionRequired type="submit" class="btn btn-primary ml-auto">Save</button>
          </div>
        </webui-generic-form>
      </div>
    </div>
  </ng-template>

  <ng-template #forgotPassword let-modal>
    <div class="modal-content-wrapper">
      <div class="modal-header-wrapper">
        <div class="modal-header">
          <h5 class="modal-title">Password Reset</h5>

          <webui-close-button
            class="ml-auto"
            (click)="modal.dismiss()"
          ></webui-close-button>
        </div>
      </div>
      <div class="py-3">
        <webui-generic-form
          endpoint="/core/contacts/forgot_password/"
          [data]="passwordData"
          (event)="resetEvent($event)"
        >
          <div class="d-flex align-items-center">
            <button webuiSubscriptionRequired type="submit" class="btn btn-primary ml-auto">Reset</button>
          </div>
        </webui-generic-form>
      </div>
    </div>
  </ng-template>

  <app-master-guide *ngIf="user.data.is_primary"></app-master-guide>
</ng-container>

<webui-site-loader *ngIf="loader"></webui-site-loader>

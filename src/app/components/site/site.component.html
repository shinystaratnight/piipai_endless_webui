<app-navigation
  logo="/assets/img/new-software.svg"
  [user]="user"
  [pages]="pagesList"
  (update)="updateNavigationList($event)"
  (changePasswordEmitter)="openChangePassword()">
</app-navigation>

<ng-container *ngIf="!identifyDevice()">
  <div class="site-page" [class.mobile-device]="isMobileDevice" *ngIf="pageData && !dashboard" [ngSwitch]="pageData.pathData.type">
    <div *ngSwitchCase="'form'" class="form-page" [class.profile-page]="isProfilePage(pageData)">
      <ng-container *ngIf="listName && !(pageData.pathData.postfix && pageData.pathData.postfix === 'fillin') && !isProfilePage(pageData)">
        <ng-container *ngTemplateOutlet="backward; context: {title: listName}"></ng-container>
      </ng-container>

      <div class="form-content"
        *ngIf="!reload && !(pageData.endpoint === '/acceptance-tests/acceptancetests/' && pageData.pathData.id) && pageData.endpoint !== '/core/forms/' || pageData.pathData.postfix === 'submit'">
          <app-generic-form
            *ngIf="!reload && pageData.endpoint !== '/core/forms/' && !pageData.pathData.postfix || pageData.pathData.postfix === 'submit' "
            [endpoint]="pageData.endpoint"
            [id]="pageData.pathData.id"
            [edit]="pageData.pathData.postfix"
            [mode]="formMode"
            [errors]="errors"
            [data]="additionalData"
            [path]="pageData.pathData.path"
            [metadataQuery]="pageData.pathData.metadataQuery"
            (event)="formEvent($event)"
            (modeEvent)="modeEvent($event)"
            (errorForm)="formError($event)"
            (permissionError)="permissionErrorHandler($event)"
            (str)="changeFormLabel($event)">
              <div class="d-flex">
                <button type="button" class="btn button-delete custom-button"
                  *ngIf="showDeleteButton()"
                  (click)="deleteElement(pageData)">
                    <i fa name="trash"></i>
                    Delete
                </button>

                <button type="button" class="btn close button-close"
                  *ngIf="formMode === FormMode.Edit"
                  (click)="changeMode(FormMode.View)">
                    Close without save
                </button>

                <button type="button" class="btn btn-primary btn-shadow ml-auto button-edit"
                  *ngIf="formMode === FormMode.View && checkPermission('update')"
                  (click)="changeMode(FormMode.Edit)">
                    <i fa name="pencil"></i>
                    Edit mode
                </button>

                <button type="submit" class="btn btn-primary button-save save"
                  *ngIf="!formStorage && formMode !== FormMode.View && (checkPermission('post') || checkPermission('update')) && (pageData.endpoint !== '/core/users/')"
                  [disabled]="saveProcess">
                    Save
                    <app-spinner *ngIf="saveProcess"></app-spinner>
                </button>

                <button type="button" class="btn btn-success mr-2 ml-auto"
                  *ngIf="formStorage && !approvedStorage && formMode === FormMode.Edit && checkPermission('post')"
                  (click)="approveFormStorage(pageData)">
                    Approve
                </button>
              </div>
          </app-generic-form>
      </div>
      <div class="form-content"
        *ngIf="pageData.endpoint === '/core/forms/'">
          <app-form-builder
            [path]="pageData.pathData.path"
            [endpoint]="pageData.endpoint"
            [id]="pageData.pathData.id"
            (str)="changeFormLabel($event)">
          </app-form-builder>
      </div>

      <div class="form-content" *ngIf="!reload && (pageData.endpoint === '/acceptance-tests/acceptancetests/' && pageData.pathData.id)">
        <app-test-builder [testData]="acceptenceTestData">
            <app-generic-form
              [endpoint]="pageData.endpoint"
              [id]="pageData.pathData.id"
              [path]="pageData.pathData.path"
              [mode]="formMode"
              (modeEvent)="modeEvent($event)"
              (errorForm)="formError($event)"
              (event)="formEvent($event)"
              (str)="setTestData($event)">
                <div class="d-flex">
                  <button type="button" class="btn button-delete custom-button"
                    *ngIf="pageData.pathData.id && checkPermission('delete')"
                    (click)="deleteElement(pageData)">
                      <i fa name="trash"></i>
                      Delete
                  </button>

                  <button type="button" class="btn close button-close"
                    *ngIf="formMode === FormMode.Edit"
                    (click)="changeMode(FormMode.View)">
                      Close without save
                  </button>

                  <button type="button" class="btn btn-primary btn-shadow ml-auto button-edit"
                    *ngIf="formMode === FormMode.View && checkPermission('update')"
                    (click)="changeMode(FormMode.Edit)">
                      <i fa name="pencil"></i>
                      Edit mode
                  </button>

                  <button type="submit" class="btn btn-primary button-save"
                    *ngIf="!formStorage && formMode !== FormMode.View && (checkPermission('post') || checkPermission('update'))"
                    [disabled]="saveProcess">
                      Save
                      <app-spinner *ngIf="saveProcess"></app-spinner>
                  </button>
                </div>
            </app-generic-form>
        </app-test-builder>
      </div>
    </div>

    <ng-container *ngSwitchCase="'list'">
      <div class="datatable-list"
        *ngIf="!pageData.pathData.postfix"
        infinite-scroll
        [scrollWindow]="true"
        (scrolled)="onModalScrollDown()">
          <app-generic-list
            [upload]="upload"
            [clientId]="getClientId()"
            [listNameCache]="listNameCache"
            [allowPermissions]="permissionMethods"
            [endpoint]="pageData.endpoint">
          </app-generic-list>
      </div>

      <div class="datatable-list" *ngIf="pageData.pathData.postfix && pageData.pathData.postfix === 'fillin'">
        <app-generic-list
          [responseField]="fillInData.responseField || 'results'"
          [paginated]="fillInData.paginated || 'on'"
          [supportData]="fillInData.supportData"
          [metaType]="fillInData.metaType"
          [actions]="fillInData.actions"
          [clientId]="getClientId()"
          [listNameCache]="listNameCache"
          [allowPermissions]="permissionMethods"
          [endpoint]="pageData.endpoint"
          (checkedObjects)="checkedObjects($event)">
            <ng-container *ngTemplateOutlet="backward; context: {form: true}"></ng-container>
        </app-generic-list>
        <div class="buttons mb-5">
          <button type="button" class="btn btn-default" (click)="back()">Cancel</button>
          <button type="button" class="btn btn-primary pr-3" (click)="sendData()">Fill in</button>
        </div>
      </div>
    </ng-container>

    <app-map *ngSwitchCase="'map'"></app-map>
  </div>
</ng-container>

<div class="dashboard" *ngIf="dashboard && isManager">
  <app-dashboard
    *ngIf="isManager"
    class="dashboard-item"
    [pages]="pagesList"
    [userModules]="userModules"
    [modulesList]="modulesList"
    (changeWidgetList)="updateNavigation($event)"></app-dashboard>

  <app-calendar class="dashboard-item"></app-calendar>
</div>

<app-mobile-timesheets [clientId]="getClientId()" *ngIf="identifyDevice()"></app-mobile-timesheets>

<app-toast></app-toast>

<ng-template #modal let-c="close" let-d="dismiss">
  <div class="modal-content-wrapper">
    <div class="modal-header-wrapper">
      <div class="modal-header">
        <h5 class="modal-title">Change Password</h5>
        <button type="button" class="close ml-2" aria-label="Close" (click)="d('Cross click')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div class="pb-3 form-builder-form">
      <app-generic-form [endpoint]="changePasswordEndpoint" [edit]="true" [needData]="false" (event)="resetEvent($event)">
        <a class="forgot" href="" (click)="openResetForm()">Forgot Password?</a>
        <div class="d-flex align-items-center">
          <button type="submit" class="btn btn-success ml-auto">Save</button>
        </div>
      </app-generic-form>
    </div>
  </div>
</ng-template>

<ng-template #forgotPassword let-c="close" let-d="dismiss">
  <div class="modal-content-wrapper">
    <div class="modal-header-wrapper">
      <div class="modal-header">
        <h5 class="modal-title">Password Reset</h5>
        <button type="button" class="close ml-2" aria-label="Close" (click)="d('Cross click')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div class="pb-3 form-builder-form">
      <app-generic-form endpoint="/core/contacts/forgot_password/" [data]="passwordData" (event)="resetEvent($event)">
        <div class="d-flex align-items-center">
          <button type="submit" class="btn btn-success ml-auto">Reset</button>
        </div>
      </app-generic-form>
    </div>
  </div>
</ng-template>

<ng-template #backward let-title="title" let-job="form">
  <div class="form-navigation">
    <ng-container *ngIf="job">
      <a href="" (click)="back($event)">
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="12px" height="6px" style="transform: rotate(90deg)" viewBox="0 0 612 612" xml:space="preserve">
          <path stroke-width="2" stroke="green" d="M604.501,134.782c-9.999-10.05-26.222-10.05-36.221,0L306.014,422.558L43.721,134.782
            c-9.999-10.05-26.223-10.05-36.222,0s-9.999,26.35,0,36.399l279.103,306.241c5.331,5.357,12.422,7.652,19.386,7.296
            c6.988,0.356,14.055-1.939,19.386-7.296l279.128-306.268C614.5,161.106,614.5,144.832,604.501,134.782z"/>
        </svg>

        Back to job info
      </a>
    </ng-container>

    <ng-container *ngIf="!job">
      <a [routerLink]="pageData.pathData.path">
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="12px" height="6px" style="transform: rotate(90deg)" viewBox="0 0 612 612" xml:space="preserve">
          <path stroke-width="2" stroke="green" d="M604.501,134.782c-9.999-10.05-26.222-10.05-36.221,0L306.014,422.558L43.721,134.782
            c-9.999-10.05-26.223-10.05-36.222,0s-9.999,26.35,0,36.399l279.103,306.241c5.331,5.357,12.422,7.652,19.386,7.296
            c6.988,0.356,14.055-1.939,19.386-7.296l279.128-306.268C614.5,161.106,614.5,144.832,604.501,134.782z"/>
        </svg>

        Back to {{title | lowercase}} list
      </a>
    </ng-container>

  </div>
</ng-template>

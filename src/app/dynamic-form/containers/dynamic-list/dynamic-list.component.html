<div #datatable [ngClass]="{'poped card p-0': poped}" class="mw-100 datatable" (click)="activeTable()" [hidden]="minimized">
  <div move [parent]="datatable" *ngIf="poped" class="card-header bg-primary text-white" (active)="activeTable($event)">
    <h5 class="d-flex justify-content-between align-items-center mb-0 lead" *ngIf="config.list">
      <span [ngClass]="{'mr-5': poped}">{{config.list.label}}</span>
      <div class="d-flex fustify-content-center align-items-center">
        <i
          fa
          class="ml-2 icon"
          [name]="'window-minimize'"
          [border]="true"
          (click)="minimizeTable()"
          aria-hidden="true"></i>
        <i
          fa
          class="ml-2 icon"
          [name]="'window-maximize'"
          [border]="true"
          (click)="unpopedTable()"
          aria-hidden="true"></i>
        <i
          fa
          class="ml-2 icon"
          [name]="'times'"
          [border]="true"
          (click)="closeTable()"
          aria-hidden="true"></i>
      </div>
    </h5>
  </div>
  <div class="datatable-content">
    <div class="filter-wrapper" *ngIf="(first || poped) && showFilters" [class.open]="!filtersHidden" [class.in-form]="inForm">
      <filter-block [config]="filtersOfList" (event)="filterHandler($event)"></filter-block>
    </div>
    <div class="background" (click)="filtersHidden = !filtersHidden"></div>
    <div [class.card-block]="poped" class="datatable-body" [class.open-filters]="!filtersHidden && showFilters">
      <h2 class="datatable-label"
        *ngIf="(config.list && (inForm && (config.list.search_enabled || (config.list.buttons && config.list.buttons.length)) && !delay) || (!inForm && !poped))">
        <span *ngIf="!inForm" class="mr-auto my-1">{{config.list.label}}</span>
        <list-buttons
          [buttons]="config.list.buttons"
          [first]="first"
          [inForm]="inForm"
          [label]="config.list.label"
          [poped]="poped"
          [allowPermissions]="allowPermissions"
          (event)="buttonAction($event)">
        </list-buttons>
      </h2>
      <div *ngIf="showFilters || config.list.search_enabled" class="datatable-header">
        <button [class.active]="!filtersHidden" class="btn btn-outline-secondary filter-button mr-3" (click)="filtersHidden = !filtersHidden" *ngIf="showFilters">
          <svg width="20" height="15" viewBox="0 0 20 15" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M 5.58236 3.51318C 4.87141 3.51318 4.29285 2.93807 4.29285 2.23032C 4.29285 1.52304 4.87141 0.94746 5.58236 0.94746C 6.29331 0.94746 6.87189 1.52304 6.87189 2.23032C 6.87189 2.93807 6.29331 3.51318 5.58236 3.51318ZM 19.0476 1.77933L 8.09522 1.77933C 7.9776 1.77933 7.87332 1.82623 7.78998 1.89682C 7.62665 0.826186 6.70379 1.30114e-07 5.58236 1.30114e-07C 4.49808 1.30114e-07 3.59142 0.770285 3.38523 1.78975C 3.36761 1.78786 3.35189 1.77933 3.33332 1.77933L 0.476187 1.77933C 0.21333 1.77933 -2.46465e-06 1.99156 -2.46465e-06 2.25306C -2.46465e-06 2.51456 0.21333 2.72679 0.476187 2.72679L 3.33332 2.72679C 3.35618 2.72679 3.37523 2.71684 3.39713 2.714C 3.61999 3.7112 4.51332 4.46064 5.58236 4.46064C 6.68903 4.46064 7.60522 3.65672 7.7857 2.60599C 7.86951 2.67894 7.97569 2.72679 8.09522 2.72679L 19.5238 2.72679C 19.7871 2.72679 20 2.51456 20 2.25306C 20 1.99156 19.7871 1.77933 19.5238 1.77933L 19.0476 1.77933ZM 19.5238 7.46419L 16.8252 7.46419C 16.7067 6.34381 15.7633 5.46505 14.6067 5.46505C 13.45 5.46505 12.5067 6.34381 12.3886 7.46419L 0.476231 7.46419C 0.213374 7.46419 4.11318e-05 7.67594 4.11318e-05 7.93792C 4.11318e-05 8.19941 0.213374 8.41164 0.476231 8.41164L 12.4943 8.41164C 12.7957 9.28899 13.6238 9.92569 14.6067 9.92569C 15.5895 9.92569 16.4176 9.28899 16.7195 8.41164L 19.5238 8.41164C 19.7867 8.41164 20 8.19941 20 7.93792C 20 7.67594 19.7867 7.46419 19.5238 7.46419ZM 14.6067 8.97823C 13.8957 8.97823 13.3172 8.40264 13.3172 7.69536C 13.3172 6.98809 13.8957 6.41251 14.6067 6.41251C 15.3176 6.41251 15.8962 6.98809 15.8962 7.69536C 15.8962 8.40264 15.3176 8.97823 14.6067 8.97823ZM 20 12.6749C 20 12.4134 19.7871 12.2012 19.5238 12.2012L 8.09522 12.2012C 7.97284 12.2012 7.86331 12.2505 7.77903 12.3263C 7.57141 11.3082 6.66569 10.5394 5.58236 10.5394C 4.53855 10.5394 3.66666 11.2561 3.41809 12.2183C 3.38952 12.213 3.36332 12.2012 3.33332 12.2012L 0.476187 12.2012C 0.21333 12.2012 -2.46465e-06 12.4134 -2.46465e-06 12.6749C -2.46465e-06 12.9369 0.21333 13.1487 0.476187 13.1487L 3.33332 13.1487C 3.34951 13.1487 3.36284 13.1416 3.37808 13.1397C 3.55665 14.1932 4.47332 15 5.58236 15C 6.72712 15 7.66283 14.1392 7.79712 13.0359C 7.87902 13.1032 7.98045 13.1487 8.09522 13.1487L 19.5238 13.1487C 19.7871 13.1487 20 12.9369 20 12.6749ZM 5.58236 14.0525C 4.87141 14.0525 4.29285 13.4774 4.29285 12.7697C 4.29285 12.0624 4.87141 11.4868 5.58236 11.4868C 6.29331 11.4868 6.87189 12.0624 6.87189 12.7697C 6.87189 13.4774 6.29331 14.0525 5.58236 14.0525Z"
                  fill="#FDFDFD" />
          </svg>
          Filters
        </button>
        <list-search-bar
          class="datatable-search"
          *ngIf="config.list.search_enabled"
          [count]="data.count"
          [label]="config.list.label"
          [list]="config.list.list"
          (event)="filterHandler($event)">
        </list-search-bar>
      </div>
      <action-element *ngIf="config.list.actions && !inForm" [count]="selectedCount" [config]="config.list.actions" (event)="actionHandler($event)"></action-element>

      <div #tableWrapper class="table-wrapper">
        <table class="table table-sm" *ngIf="config.list">
          <thead class="thead-default">
            <tr>
              <th *ngIf="(!inForm && config.list.actions) || actions || !noneEdit" class="active first-cell" style="width: 2rem">
                <div *ngIf="(!inForm && config.list.actions) || actions">
                  <label for="all-checkbox">All</label>
                  <input
                    id="all-checkbox"
                    type="checkbox"
                    hidden
                    *ngIf="config.list.actions || actions"
                    [(ngModel)]="selectedAll"
                    (ngModelChange)="selectAll()">
                </div>
              </th>
              <th *ngFor="let field of config.list.columns;" [hidden]="field.tab && field.tab.is_collapsed">
                <ng-container
                  listElement
                  [head]="true"
                  [config]="field"
                  (event)="sorting(field)">
                </ng-container>
                <i fa
                  class="sort-icon"
                  *ngIf="field.sort && !delay"
                  [name]="field.sorted === 'asc' ? 'angle-up' : 'angle-down'"
                  [class.active]="field.sorted && !delay"
                  [border]=true
                  (click)="field.openSort = !field.openSort"></i>
                <ul *ngIf="field.sort && !delay && field.openSort" class="sort-parameters">
                  <li [class.active]="field.sorted === 'asc'" (click)="sorting(field, 'asc'); field.openSort = false">Alphabetically A-Z</li>
                  <li [class.active]="field.sorted === 'desc'" (click)="sorting(field, 'desc'); field.openSort = false">Alphabetically Z-A</li>
                </ul>
              </th>
              <th *ngIf="config.list.tabs" class="last-cell">More</th>
            </tr>
          </thead>
          <tbody *ngIf="body && !refresh">
            <ng-container *ngFor="let row of body">
              <tr [class.main]="row.additionalBody && !row.collapsed" [class.table-warning]="row.highlight && row.highlight.highlight"
                [ngStyle]="row.highlight && row.highlight.color && {'background-color': row.highlight.color}">
                <td *ngIf="(!inForm && config.list.actions) || actions || !noneEdit" class="first-cell">
                  <label *ngIf="config.list.actions || actions">
                    <input type="checkbox"
                      class="form-check-input"
                      [(ngModel)]="select[row.id]"
                      [checked]="select[row.id]"
                      (ngModelChange)="emitSelect()" hidden>
                    <div class="custom-checkbox">
                      <i fa name="check"></i>
                    </div>
                  </label>
                  <a class="first-cell-link not-underline" *ngIf="first && !inForm && !config.list.editDisable && checkPermission('get') && !noneEdit" [routerLink]="[row.id + '/change']">
                    <i fa
                      name="pencil"
                      class="icon">
                    </i>&nbsp;Edit
                  </a>
                  <i fa
                    *ngIf="!first && !config.list.editDisable && checkPermission('get')"
                    name="pencil"
                    class="icon"
                    (click)="editObject(row.id, row.__str__)"></i>
                </td>

                <td *ngFor="let cell of row.content" [attr.data-label]="cell.label" [hidden]="cell.tab && cell.tab.is_collapsed">
                  <ng-container
                    *ngIf="cell.name !== 'actions'"
                    listElement
                    [config]="cell.content"
                    (event)="eventHandler($event)"
                    (buttonAction)="buttonHandler($event)">
                  </ng-container>

                  <ng-container *ngIf="cell.name === 'actions'">
                    <template #actionsTemplate>
                      <ng-container
                        listElement
                        [config]="cell.content"
                        (event)="eventHandler($event)"
                        (buttonAction)="buttonHandler($event, cell.pop = pop)">
                      </ng-container>
                    </template>
                    <i fa class="icon px-1 ml-4" name="ellipsis-v" placement="bottom" #pop="ngbPopover" [ngbPopover]="actionsTemplate" style="opacity: .3"></i>
                  </ng-container>

                  <div *ngIf="innerTables && innerTables[row.id] && innerTables[row.id][cell.name]">
                    <list-table *ngIf="innerTables[row.id][cell.name].body" [config]="innerTables[row.id][cell.name]"></list-table>
                  </div>
                </td>

                <td *ngIf="config.list.tabs" class="last-cell">
                  <i fa
                    class="more-icon"
                    [name]="row.collapsed ? 'angle-down' : 'angle-up'"
                    (click)="row.collapsed = !row.collapsed">
                  </i>
                </td>

              </tr>
              <tr *ngIf="row.additionalBody && !row.collapsed">
                <td *ngIf="(!inForm && config.list.actions) || actions || !noneEdit">&nbsp;</td>
                <td [attr.colspan]="row.content.length">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th *ngFor="let acell of row.additionalBody.content">{{acell.label}}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td *ngFor="let acell of row.additionalBody.content">
                          <div class="additional-data" *ngFor="let field of acell.content">
                            <span *ngIf="field.content && acell.content.length > 1 && acell.label !== 'Character'" class="description">{{field.label}}</span>
                            <span class="additional-data-content">
                              <ng-container *ngFor="let innerField of field.content"
                                listElement
                                [config]="innerField"
                                (event)="eventHandler($event)"
                                (buttonAction)="buttonHandler($event)">
                              </ng-container>
                            </span>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </td>
                <td *ngIf="config.list.tabs">&nbsp;</td>
              </tr>
            </ng-container>
          </tbody>
        </table>
        <div *ngIf="refresh" class="spinner">
          <div class="double-bounce1"></div>
          <div class="double-bounce2"></div>
        </div>
      </div>
      <div *ngIf="pageSize" class="d-flex flex-wrap align-items-center py-3">
        <ngb-pagination
          [collectionSize]="pageSize"
          [(page)]="page"
          [maxSize]="2"
          [rotate]="true"
          [ellipses]="true"
          [boundaryLinks]="true"
          size="sm"
          (pageChange)="pageChange()">
        </ngb-pagination>
        <div class="ml-2">{{data.count}} {{config.list.pagination_label || config.list.label}}</div>
      </div>
    </div>
  </div>
</div>


<template #modal let-c="close" let-d="dismiss">
  <div class="modal-content-wrapper">
    <div class="modal-header-wrapper">
      <div class="modal-header">
        <h5 class="modal-title">{{modalInfo.label}}</h5>
        <button type="button" class="close ml-2" aria-label="Close" (click)="d('Cross click')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div class="modal-body" [ngSwitch]="modalInfo.type">
      <generic-form
        *ngSwitchCase="'form'"
        [endpoint]="modalInfo.endpoint"
        [metadataQuery]="!modalInfo.dontUseMetadataQuery ? addMetadataQuery || metadataQuery : ''"
        [data]="modalInfo.data"
        [id]="modalInfo.id"
        [mode]="modalInfo.mode"
        [edit]="modalInfo.edit"
        (event)="formEvent($event, c)"
        (errorForm)="formError($event)">
          <button type="submit" class="btn btn-secondary bg-primary text-white" [disabled]="saveProcess">
            Save
            <spinner *ngIf="saveProcess"></spinner>
          </button>
      </generic-form>
      <sebm-google-map
        *ngSwitchCase="'map'"
        [latitude]="modalInfo.latitude"
        [longitude]="modalInfo.longitude"
        [zoom]="13"
        [mapTypeControl]="true">
          <sebm-google-map-marker [latitude]="modalInfo.latitude" [longitude]="modalInfo.longitude"></sebm-google-map-marker>
      </sebm-google-map>
      <profile [id]="modalInfo.id" *ngSwitchCase="'profile'"></profile>
    </div>
  </div>
</template>

<template #confirmModal let-c="close">
  <div class="modal-header">
    <p>{{modalInfo.message}}</p>
    <button type="button" class="close" aria-label="Close" (click)="d(false)">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="callAction(modalInfo, c)">{{modalInfo.agree_label}}</button>
    <button type="button" class="btn btn-secondary" (click)="c(false)">{{modalInfo.decline_label}}</button>
  </div>
</template>

<template #evaluateModal let-c="close">
  <div class="modal-header">
    <div class="d-flex align-items-center">
      <img class="mr-2" [src]="modalInfo.label.picture" alt="Photo" width="40" height="40">
      <h5 class="mb-0">{{modalInfo.label.name}}</h5>
    </div>
    <button type="button" class="close" aria-label="Close" (click)="c(false)">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <generic-form
      [needData]="modalInfo.needData"
      [endpoint]="modalInfo.endpoint"
      [data]="modalInfo.data"
      [edit]="modalInfo.edit"
      (event)="evaluateEvent($event, c)">
        <button class="btn btn-primary mr-auto text-white">Submit</button>
    </generic-form>
  </div>
</template>

<template #sendMessageModal let-c="close">
  <div class="modal-body">
    <iframe class="send-sms" [src]="modalInfo.url" frameborder="0"></iframe>
    <br>
  </div>
</template>

<template #showPreviewInvoice>
  <div class="modal-body">
    <pdf-viewer [src]="modalInfo.url" [render-text]="true" style="display: block;"></pdf-viewer>
    <br>
  </div>
</template>

<template #fillInMap>
  <sebm-google-map [latitude]="modalInfo.latitude" [longitude]="modalInfo.longitude" [zoom]="13" [mapTypeControl]="true">
    <sebm-google-map-marker [iconUrl]="marker.iconUrl" *ngFor="let marker of modalInfo.markers" [latitude]="marker.latitude" [longitude]="marker.longitude">
      <sebm-google-map-info-window>
        <strong>{{marker.name}}</strong>
        <br>
        <p>{{marker.description}}</p>
      </sebm-google-map-info-window>
    </sebm-google-map-marker>
  </sebm-google-map>
</template>

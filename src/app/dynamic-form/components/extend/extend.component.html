<div class="wrapper">
  <div class="title">Select Dates</div>

  <div class="text-center">
    <ng-container
      appFormElement
      [config]="viewConfig.shiftsDates"
      [group]="viewData"
      (event)="eventHandler($event)">
    </ng-container>
  </div>

  <div class="form-element-inline-container">
    <b>Extend:</b>

    <ng-container
      appFormElement
      [config]="viewConfig.extendDates"
      (event)="autofillDates($event)"
      [group]="viewData">
    </ng-container>

    <ng-container
      appFormElement
      [config]="viewConfig.extendCandidates"
      (event)="autofillCandidates($event)"
      [group]="viewData">
    </ng-container>

    <app-info class="pl-2"
      *ngIf="!someUnavailable"
      placement="right"
      [description]="fillinfo">
    </app-info>

    <app-info class="pl-2"
      *ngIf="someUnavailable"
      [danger]="true"
      placement="right"
      [triggersType]="'click:click'"
      [description]="availableinfo">
    </app-info>

    <span class="text-success pl-2" *ngIf="someUnavailable">| Candidate was replaced for some dates, due to unavailability</span>
  </div>

  <div class="shifts-header">
    <div class="title">Shifts</div>

    <button type="button" class="btn btn-primary" (click)="autocompleteCandidates()">Autocomplete</button>
    <app-info [placement]="'bottom'" [description]="requirements"></app-info>
  </div>


  <ng-container *ngIf="shifts">
    <div class="shift" *ngFor="let shift of shifts; let i = index">
      <div class="d-flex align-items-center mb-2">
        <span class="shift-date">{{shift.date}}</span> | <button type="button" class="btn btn-link" (click)="addTime(shift)">Add shift <i fa name="plus-circle"></i></button>
      </div>

      <div class="col">
        <ng-container *ngFor="let group of shift.data.controls; let index = index">
          <ng-container *ngIf="shift.config[index]">
            <ng-container *ngTemplateOutlet="date; context: {group: group, config: shift.config[index], index: index, target: shift.data, parentIndex: i}"></ng-container>
          </ng-container>
        </ng-container>
      </div>
    </div>
  </ng-container>
</div>

<ng-template #requirements>
  <div class="info-block">
    <h6>Fills shifts automatically using criteria:</h6>
    <ul>
      <li><i fa class="icon" name="circle"></i>Candidate Score</li>
      <li><i fa class="icon" name="circle"></i>Distanse to the jobsite</li>
    </ul>
  </div>
</ng-template>

<ng-template #fillinfo>
  <div *ngIf="autoFillData" class="info-block">
    <h6>Use information from last fullfilled shift:</h6>
    <ul *ngFor="let date of autoFillData">
      <li><i fa class="icon" name="circle"></i>{{date.shift_datetime | dateFormat: 'datetime'}}</li>
      <li *ngFor="let candidate of date.candidates"><i fa class="icon" name="circle"></i>{{candidate.__str__}}</li>
    </ul>
  </div>
  <div class="text-danger" *ngIf="!autoFillData">Fulfilled shift doesn't exist on this job!</div>
</ng-template>

<ng-template #date let-group="group" let-config="config" let-index="index" let-target="target" let-parentIndex="parentIndex">

  <div class="row">
    <div class="time">
      <ng-container
        appFormElement
        [config]="config.time"
        (event)="timeChange($event, config)"
        [group]="group">
      </ng-container>
    </div>

    <div class="workers">
      <ng-container
        appFormElement
        [config]="config.workers"
        (event)="change($event)"
        [group]="group">
      </ng-container>
    </div>

    <div class="candidates">
      <ng-container
        appFormElement
        [config]="config.candidates"
        (event)="change($event)"
        [group]="group">
      </ng-container>
    </div>

    <i fa name="times" class="text-secondary icon align-self-start" (click)="removeTime(target, index, parentIndex)"></i>
  </div>

</ng-template>

<ng-template #availableinfo>
  <div class="available-info">
    <h6 class="available-info-title">Unavailable candidates , dates and reason</h6>

    <div class="candidate-available-info" *ngFor="let candidate of availabilityCandidates">
      <span class="candidate-name">{{candidate.candidateName}}</span>
        <div class="available-info-detail" *ngFor="let shift of candidate.shifts">
          <div class="available-info-datetime">
            {{shift.datetime | dateFormat:'datetime'}}
          </div>
          <span *ngFor="let message of shift.messages">
            {{message.status}}&nbsp;
            <a class="description"
              *ngIf="message.job"
              href="{{'/hr/jobs/' + message.job + '/change'}}"
              target="_black">
                &nbsp;to {{message.message}}
            </a>
          </span>
        </div>
    </div>
  </div>
</ng-template>

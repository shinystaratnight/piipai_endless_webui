<div *ngIf="!this.config.hide && !this.dropdown" class="timeline">
  <template *ngFor="let state of config.options; let last = last"
    [ngTemplateOutlet]="stateElement"
    [ngOutletContext]="{state: state, last: last}">
  </template>
</div>

<div *ngIf="selectArray && currentState && this.dropdown" class="timeline timeline-select-wrapper">
  Status:

  <select class="timeline-element badge badge-outline timeline-select"
    [ngClass]="{
      'need-requirements': getState(currentState).state === 0,
      'allowed': getState(currentState).state === 1,
      'active': getState(currentState).state === 2,
      'visited': getState(currentState).state === 3,
      'not-allowed': getState(currentState).state === 4
    }"
    [(ngModel)]="currentState">
      <option *ngFor="let option of selectArray" [value]="option.id">
        <span *ngIf="option.state === 2">
          {{(option.name_after_activation) ? option.name_after_activation : option.name_before_activation}}
        </span>
        <span *ngIf="option.state !== 2">
          {{option.name_before_activation}}
        </span>
      </option>
  </select>

  <info *ngIf="getState(currentState).state === 0" [description]="requirements"></info>
  <button type="button" (click)="open(getState(currentState))" *ngIf="getState(currentState).state === 1" class="btn btn-sm badge badge-outline">
    <i fa name="check"></i>
  </button>
</div>

<template #stateModal let-c="close" let-d="dismiss">
  <div class="modal-content-wrapper">
    <div class="modal-header">
      <h5 class="modal-title">{{modalData.title}}</h5>
      <button type="button" class="close" (click)="c()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body timeline" *ngIf="modalData">
      <ng-container *ngIf="(modalData.tests || modalData.substates) && !modalData.setActive">
        <div class="state-info">
          <div class="state-item">
            <h5>Substates</h5>

            <div class="state-substate"
              [ngClass]="{
                'need-requirements': substate.state === 0,
                'allowed': substate.state === 1,
                'active': substate.state === 2,
                'visited': substate.state === 3,
                'not-allowed': substate.state === 4
              }"
              *ngFor="let substate of modalData.substates"
              (click)="open(substate, c)">
              {{substate.name_before_activation}}
            </div>

          </div>

          <div div class="state-item">
            <h5>Acceptance Tests</h5>

            <table class="table">
              <tr>
                <th>Name</th>
                <th>Score</th>
                <th>&nbsp;</th>
              </tr>

              <tr *ngFor="let test of modalData.tests">
                <td>{{test.acceptance_test.name}}</td>
                <td>{{test.score}}</td>
                <td>
                  <button *ngIf="test.score === 0" class="btn btn-sm btn-primary" (click)="fillinTest(test.acceptance_test.id)">Fill in</button>
                </td>
              </tr>
            </table>
          </div>
        </div>

        <button class="btn btn-sm btn-primary mt-3" (click)="modalData.setActive = true">
          Activate
        </button>
      </ng-container>

      <div *ngIf="(!modalData.tests && !modalData.substates) || modalData.setActive">
        <generic-form [endpoint]="objectEndpoint" [id]="modalData.id" [data]="stateData" (event)="sendEventHandler($event, c)">
          <button type="submit" class="btn btn-primary">Save</button>
        </generic-form>
      </div>
    </div>
  </div>
</template>

<template #stateElement let-state="state" let-l="last">
  <div class="timeline-element-wrapper" style="position: relative">
    <div class="timeline-element badge badge-outline" [ngClass]="{
              'need-requirements': state.state === 0,
              'allowed': state.state === 1,
              'active': state.state === 2,
              'visited': state.state === 3,
              'not-allowed': state.state === 4
            }" (click)="open(state)">
      <span *ngIf="state.state === 2">
        {{(state.name_after_activation) ? state.name_after_activation : state.name_before_activation}}
      </span>
      <span *ngIf="state.state !== 2 && state.state !== 0">
        {{state.name_before_activation}}
      </span>
      <span *ngIf="state.state === 0" placement="bottom" [ngbTooltip]="requir">
        {{state.name_before_activation}}
      </span>
    </div>
    <svg class="arrow" *ngIf="!l" width="5" height="8" viewBox="0 0 5 8" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L3 3L6 0" transform="translate(1 7) rotate(-90)" stroke="#1BD168" />
    </svg>
    <template #requir>
      <div class="info-block">
        <h6>To activate this state, fill in the required fields:</h6>
        <ul>
          <li *ngFor="let option of state.requirements">
            <i fa class="icon" name="circle"></i>
            {{option}}
          </li>
        </ul>
      </div>
    </template>
  </div>
</template>

<template #requirements>
  <div class="info-block">
    <h6>To activate this state, fill in the required fields:</h6>
    <ul>
      <li *ngFor="let option of getState(currentState).requirements">
        <i fa class="icon" name="circle"></i>
        {{option}}
      </li>
    </ul>
  </div>
</template>

<template #test let-c="close">
    <div class="modal-content-wrapper">
      <div class="modal-header-wrapper">
        <div class="modal-header">
          <button type="button" class="close ml-auto" aria-label="Close" (click)="c()">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <test-generator [workflowObject]="modalData.workflowObject" [send]="true" [id]="testId"></test-generator>
      </div>
    </div>
  </template>

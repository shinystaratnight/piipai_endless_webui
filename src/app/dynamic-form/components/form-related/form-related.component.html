<div *ngIf="!config.list" class="form-group" [formGroup]="group">
  <div *ngIf="!config.many" style="position: relative">
    <label *ngIf="label && config.templateOptions.label" [attr.for]="key">{{config.templateOptions.label}}</label>
    <div class="d-flex align-items-center">
      <div class="form-control custom-select autocomplete-value"
        [ngClass]="{'active': !config.readonly}"
        (click)="openAutocomplete()">
        <div style="overflow: hidden; white-space: nowrap">{{displayValue}}</div>
      </div>
      <div class="btn-group" role="group"
        *ngIf="config.templateOptions.add || config.templateOptions.edit || config.templateOptions.delete" >
        <button type="button" class="btn btn-secondary"
          *ngIf="config.templateOptions.edit && displayValue"
          (click)="open('edit')">
          <i fa class="text-primary icon"
            [name]="'pencil'"></i>
        </button>
        <button type="button" class="btn btn-secondary"
          *ngIf="config.templateOptions.add"
          (click)="open('add')">
          <i fa class="text-success icon"
            [name]="'plus'" ></i>
        </button>
        <button type="button" class="btn btn-secondary"
          *ngIf="config.templateOptions.delete && displayValue"
          (click)="open('delete')">
          <i fa class="text-danger icon"
            [name]="'times'"></i>
        </button>
      </div>
    </div>

    <div class="card autocomplete p-1" [hidden]="hideAutocomplete">
      <input type="text" class="form-control mb-1" autocomplete="off"
        #search
        [(ngModel)]="searchValue"
        [ngModelOptions]="{standalone: true}"
        (blur)="resetList()"
        (keyup)="filter(searchValue)">
      <div #autocomplete class="autocomplete-list"
        infinite-scroll
        [infiniteScrollDistance]="modalScrollDistance"
        [infiniteScrollThrottle]="modalScrollThrottle"
        [scrollWindow]="false"
        (scrolled)="onModalScrollDown()"
        [hidden]="!(previewList && previewList.length)">
        <ul class="list-group w-100">
          <li class="list-group-item autocomplete-item p-1 pl-2" style="cursor: pointer"
            *ngFor="let option of previewList"
            (click)="setValue(option)">{{option[display]}}</li>
        </ul>
      </div>
    </div>
  </div>

  <div *ngIf="config.many" style="position: relative">
    <label *ngIf="label && config.templateOptions.label" [attr.for]="key">{{config.templateOptions.label}}</label>
    <input type="text" class="form-control custom-select autocomplete-value" autocomplete="off"
      [(ngModel)]="searchValue"
      [ngModelOptions]="{standalone: true}"
      [ngClass]="{'active': !config.readonly}"
      (focus)="generateList()"
      (blur)="resetList()"
      (keyup)="filter(searchValue)">
      <div class="autocomplete" [hidden]="!(previewList && previewList.length)">
        <div class="autocomplete-list"
          infinite-scroll
          [infiniteScrollDistance]="modalScrollDistance"
          [infiniteScrollThrottle]="modalScrollThrottle"
          [scrollWindow]="false"
          (scrolled)="onModalScrollDown()">
          <ul class="list-group w-100">
            <li class="list-group-item autocomplete-item p-1 pl-2" style="cursor: pointer"
              *ngFor="let option of previewList"
              (click)="setValue(option)">{{option[display]}}</li>
          </ul>
        </div>
      </div>
    <div class="d-flex flex-wrap align-items-center mt-2">
      <span class="d-flex align-items-center badge badge-default mb-1 mr-2 p-2" style="white-space: normal"
        *ngFor="let item of results; let i = index">
        {{item[display]}}
        <i fa class="text-white icon ml-2"
          (click)="deleteItem(i)"
          [name]="'times'"></i>
      </span>
    </div>
  </div>

  <small class="text-muted" *ngIf="config.templateOptions.description">
    {{config.templateOptions.description}}
  </small>
  <div *ngIf="errors">
    <div class="text-danger mt-1" *ngIf="errors[config.key]">{{errors[config.key]}}</div>
  </div>
  <div *ngIf="message">
    <div *ngIf="message[config.key]" class="text-success mt-1">{{message[config.key]}}</div>
  </div>
</div>

<div class="mb-2" *ngIf="config.list">
  <h5 class="bg-primary text-white mb-0">
    <i
      fa
      class="p-2"
      [name]="isCollapsed ? 'eye' : 'eye-slash'"
      [border]=false
      (click)="isCollapsed = !isCollapsed"
      [attr.aria-expanded]="!isCollapsed"
      aria-controls="collapseExample"
      style="cursor: pointer"></i>
        {{config.templateOptions.label}}
  </h5>
  <div id="collapseExample" [ngbCollapse]="isCollapsed" class="px-2">
    <table *ngIf="dataOfList" class="table table-bordered">
      <thead>
        <tr>
          <th *ngFor="let col of config.metadata">
            {{col.templateOptions.label}}
          </th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let object of dataOfList">
          <td *ngFor="let field of object.metadata;">
            <ng-container
              formElement
              [label]="false"
              [config]="field"
              [group]="object.data"
              (event)="updateValue($event)">
            </ng-container>
          </td>
          <td>
            <span *ngIf="object.id" class="d-flex align-items-center justify-content-center">
              <i fa class="icon text-danger" title="Delete"
                [name]="'trash'"
                (click)="deleteObject(object)"></i>
            </span>
          </td>
        </tr>
      </tbody>
    </table>
    <a *ngIf="dataOfList" href="#" (click)="addObject($event)">
        <i fa [name]="'plus'" class="icon text-success"></i>
        Add {{config.templateOptions.label}}
    </a>
  </div>
</div>

<template #modal let-c="close" let-d="dismiss">
  <div class="modal-content-wrapper">
    <div class="modal-header-wrapper">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">{{modalData.title}}</h5>
        <button type="button" class="close ml-2" (click)="c()">
          <span class="text-white" aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>

    <div class="modal-body">
      <div *ngIf="modalData.type !== 'delete'">
        <generic-form [endpoint]="modalData.endpoint" [id]="modalData.id" (event)="formEvent($event, c, type)">
          <button type="submit" class="btn btn-primary">Save</button>
        </generic-form>
      </div>
      <div *ngIf="modalData.type === 'delete'">
        Are you sure?
      </div>
    </div>

    <div *ngIf="modalData.type === 'delete'" class="modal-footer">
      <button type="button" class="btn btn-danger"
        (click)="deleteElement(c)">Delete</button>
    </div>
  </div>
</template>


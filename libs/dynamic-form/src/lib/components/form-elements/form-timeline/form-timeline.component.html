<div *ngIf="!this.config.hide && !this.dropdown && !loading" class="timeline">
  <ng-container *ngFor="let state of config.options; let last = last">
    <ng-container *ngTemplateOutlet="stateElement; context: {state: state, last: last}"></ng-container>
  </ng-container>
</div>

<div *ngIf="loading && !this.dropdown" class="spinner">
  <div class="double-bounce1"></div>
  <div class="double-bounce2"></div>
</div>

<div *ngIf="selectArray && currentState && this.dropdown" class="timeline timeline-select-wrapper">
  Status:

  <select class="timeline-element badge badge-outline timeline-select"
    [ngClass]="{
      'need-requirements': getState(currentState).state === 0,
      'allowed': getState(currentState).state === 1,
      'active': getState(currentState).state === 2,
      'visited': getState(currentState).state === 3,
      'not-allowed': getState(currentState).state === 4
    }"
    [(ngModel)]="currentState">
      <option *ngFor="let option of selectArray" [value]="option.id">
        <span *ngIf="option.state === 2">
          {{(option.name_after_activation) ? option.name_after_activation : option.name_before_activation}}
        </span>
        <span *ngIf="option.state !== 2">
          {{option.name_before_activation}}
        </span>
      </option>
  </select>

  <app-info *ngIf="getState(currentState).state === 0" triggersType="click:click" [description]="requirements"></app-info>
  <button type="button" class="btn btn-sm d-flex align-items-center"
    *ngIf="getState(currentState).state === 1"
    [class.active]="saveProcess"
    (click)="open(getState(currentState))">
      <fa-icon class="f-size-10" icon="check" *ngIf="!saveProcess"></fa-icon>
      <app-spinner *ngIf="saveProcess" [sm]="true"></app-spinner>
  </button>
</div>

<ng-template #stateModal let-modal>
  <div class="modal-content-wrapper">
    <div class="modal-header">
      <h5 class="modal-title">{{modalData.title}}</h5>

      <app-close-button class="ml-auto" (click)="modal.dismiss()"></app-close-button>
    </div>

    <div class="modal-body timeline" *ngIf="modalData">
      <ng-container *ngIf="(modalData.tests || modalData.substates) && !modalData.setActive">
        <div class="state-info">
          <div *ngIf="modalData.substates">
            <h5 class="state-info-label">Substates</h5>

            <span *ngFor="let substate of modalData.substates" (click)="open(substate, modal.close)">
              <ng-container *ngTemplateOutlet="stateTemplate; context: {state: substate}"></ng-container>
            </span>

          </div>

          <div div class="state-tests">
            <h5 class="state-info-label">Acceptance Tests</h5>

            <table class="table table-sm">
              <tr>
                <th>Name</th>
                <th>Score</th>
                <th>&nbsp;</th>
              </tr>

              <tr *ngFor="let test of modalData.tests">
                <td>{{test.acceptance_test.name}}</td>
                <td>{{test.score}}</td>
                <td>
                  <a href="" *ngIf="!test.score" (click)="fillinTest($event, test.acceptance_test.id, modal.close)">Fill in</a>
                </td>
              </tr>
            </table>
          </div>
        </div>

        <hr>

        <div class="footer">
          <button *ngIf="modalData.workflowObject && this.advancedSeving" class="btn btn-sm btn-primary" (click)="modalData.setActive = true">
            Update
          </button>

          <span *ngIf="modalData.state.total_score">Total Score: {{modalData.state.total_score}}</span>
        </div>
      </ng-container>

      <div *ngIf="(!modalData.tests && !modalData.substates) || modalData.setActive">
        <app-generic-form
          [mode]="'edit'"
          [endpoint]="workflowObjectEndpoint"
          [id]="modalData.id"
          [data]="stateData"
          (event)="sendEventHandler($event, modal.close)"
          (errorForm)="formError()">
            <button type="submit" class="btn btn-primary">
              Save
              <app-spinner *ngIf="saveProcess"></app-spinner>
            </button>
        </app-generic-form>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #stateElement let-state="state" let-l="last">
  <div class="timeline-element-wrapper" style="position: relative" (click)="open(state)">
    <ng-container *ngTemplateOutlet="stateTemplate; context: {state: state}"></ng-container>

    <svg class="arrow" *ngIf="!l" width="5" height="8" viewBox="0 0 5 8" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L3 3L6 0" transform="translate(1 7) rotate(-90)" stroke="#1BD168" />
    </svg>
  </div>
</ng-template>

<ng-template #stateTemplate let-state="state">
  <div class="timeline-element badge badge-outline"
    [ngClass]="{
      'need-requirements': state.state === 0,
      'allowed': state.state === 1,
      'active': state.state === 2,
      'visited': state.state === 3,
      'not-allowed': state.state === 4,
      'save': state.saveProcess
    }">
      <span *ngIf="state.state === 2">
        {{(state.name_after_activation) ? state.name_after_activation : state.name_before_activation}}
      </span>
      <span *ngIf="state.state !== 2 && state.state !== 0">
        {{state.name_before_activation}}
      </span>
      <span *ngIf="state.state === 0" placement="bottom" [ngbTooltip]="requir">
        {{state.name_before_activation}}
      </span>

      <span class="state-progress">{{calculateProgress(state)}}</span>

      <app-spinner *ngIf="state.saveProcess" [sm]="true"></app-spinner>
  </div>
  <ng-template #requir>
    <div class="info-block">
      <h6>To activate this state, fill in the required fields:</h6>
      <ul>
        <li *ngFor="let option of state.requirements">
          <fa-icon class="icon" [icon]="['fas', 'circle']"></fa-icon>
          {{option}}
        </li>
      </ul>
    </div>
  </ng-template>
</ng-template>

<ng-template #requirements>
  <div class="info-block">
    <h6>To activate this state, fill in the required fields:</h6>
    <ul>
      <li *ngFor="let option of getState(currentState).requirements">
        <fa-icon class="icon" [icon]="['fas', 'circle']"></fa-icon>
        {{option}}

        <a *ngIf="verifyPhone(option)" class="text-primary" href="#" (click)="editContact($event)">Edit contact</a>
      </li>
    </ul>
  </div>
</ng-template>

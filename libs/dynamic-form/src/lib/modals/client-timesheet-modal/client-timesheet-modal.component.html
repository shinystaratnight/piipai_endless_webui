<div class="approve-signature-modal modal-content-wrapper">
  <div class="modal-header-wrapper">
    <div class="modal-header">
      <img alt="Photo" width="54" height="54" *ngIf="config.label.picture" [src]="config.label.picture" />
      <h2 class="modal-title d-flex align-items-center">
        <div class="mr-3">
          <span class="contact-avatar avatar" *ngIf="!config.label.picture">
            {{ config.label.contactAvatar }}
          </span>
        </div>
        <div class="d-flex justify-content-center flex-column">
          {{ 'approve_timesheet' | translate: { Default: 'Approve timesheet' } }}
          <br />
          <span class="secondary-title">for {{ config.label.name }}</span>
        </div>
      </h2>

      <app-close-button class="close-button ml-auto" (click)="modal.dismiss()"></app-close-button>
    </div>
  </div>

  <div class="modal-body pt-0">
    <div [class.steps]="
        (config.changeEndpoint && identifyDevice()) ||
        (landscape() && !config.approve)
      " [class.signature-step]="config.signatureStep">
      <div class="content-info">
        <div *ngIf="config.timesheet" class="flex-fill">
          <div class="desktop-version">
            <h3 class="group-title hide-sm">
              {{ 'times.label' | translate: { Default: 'Times' } }}
            </h3>

            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'Date',
                  key: 'date',
                  value: config.timesheet.date
                }
              "></ng-container>
            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'Start',
                  key: 'start',
                  value: config.timesheet.started_at,
                  muted: true
                }
              "></ng-container>
            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'Break',
                  key: 'break',
                  value: config.timesheet.break,
                  muted: true
                }
              "></ng-container>
            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'End',
                  key: 'end',
                  value: config.timesheet.ended_at,
                  muted: true
                }
              "></ng-container>
            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'Total time',
                  key: 'total_time.label',
                  value: config.timesheet.total,
                  totalTime: true
                }
              "></ng-container>
          </div>

          <div class="mobile-version">
            <div class="date">
              {{
              config.timesheet.unformated_date
              | dateFormat: 'DD MMM YYYY'
              }}
            </div>

            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'Shift start/end',
                  key: 'shift_start_end',
                  value: config.timesheet.shift_start_end,
                  muted: true
                }
              "></ng-container>
            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'Break start/end',
                  key: 'break',
                  value: config.timesheet.break_start_and,
                  muted: true
                }
              "></ng-container>
            <ng-container *ngTemplateOutlet="
                line;
                context: {
                  label: 'Total time',
                  key: 'total_time.label',
                  value: config.timesheet.total,
                  totalTime: true
                }
              "></ng-container>
          </div>
        </div>

        <div [hidden]="!config.timesheetData" class="form-wrapper">
          <app-generic-form [needData]="false" [form]="config.form" [endpoint]="config.changeEndpoint"
            [metadataQuery]="config.metadataQuery" [changeMetadata]="config.changeMetadata"
            [data]="config.timesheetData" [extendData]="config.extendData" [edit]="config.edit"
            (event)="this.config.evaluateEvent($event, modal.close)">
            <button #sendFormButton type="submit" [hidden]="true"></button>
          </app-generic-form>
        </div>

        <ng-template #line let-label="label" let-value="value" let-total="totalTime" let-muted="muted" let-key="key">
          <div class="time-line d-flex align-items-center flex-wrap" [class.text-success]="total">
            <span class="label" [class.description]="muted">
              {{ key | translate: { Default: label } }}:
            </span> <span>{{ value }}</span>
          </div>
        </ng-template>

        <div class="flex-fill evaluation-content" [class.evaluated]="config.evaluated">
          <h4 class="headline-4">
            {{ 'evaluate.label' | translate: { Default: 'Evaluation' } }}
          </h4>

          <div class="evaluation-wrapper d-flex align-items-center text-warning">
            <div class="rating d-inline-flex" [class.filled]="config.data.evaluation_score">
              <ngb-rating min="1" max="5" [(ngModel)]="config.data.evaluation_score"
                [rate]="config.data.evaluation_score" [readonly]="config.evaluated" (hover)="hovered = $event"
                (leave)="hovered = undefined" (rateChange)="hovered = undefined">
                <ng-template let-fill="fill" let-index="index">
                  <span *ngIf="fill === 100" class="star star-lg full">&#9733;</span>
                  <span *ngIf="fill === 0" class="star star-lg">{{ config.data.evaluation_score ? '&#9733;' :
                    '&#9734;' }}</span>
                </ng-template>
              </ngb-rating>
            </div>
            &nbsp;{{ config.data.evaluation_score }}
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-center align-items-center flex-column">
        <div [hidden]="!config.signature" class="signature-content">
          <app-back-link *ngIf="
              (config.changeEndpoint && identifyDevice()) ||
              (landscape() && !config.approve)
            " label="Back to times" key="back" (backEvent)="config.signatureStep = false">
          </app-back-link>

          <h3 class="group-title signature-title d-flex align-items-center w-100">
            {{ 'signature' | translate: { Default: 'Signature' } }}
            <button *ngIf="config.signature" type="button"
              class="btn btn-link text-danger ml-auto pr-0 py-0 only-mobile" (click)="signatureCanvas.clear()">
              {{ 'clear' | translate: { Default: 'Clear area' } }}
            </button>
          </h3>
          <app-signature #signatureCanvas [supervisorSignature]="config.supervisor_signature"
            (signature)="config.updateSignature($event)"></app-signature>
        </div>
      </div>
    </div>

    <div class="modal-footer" [class.signature-step-footer]="config.signature">
      <button *ngIf="config.signature" type="button" class="btn clear-button"
        [class.signature-step]="config.signatureStep" (click)="signatureCanvas.clear()">
        {{ 'clear' | translate: { Default: 'Clear' } }}
      </button>
      <button type="button" class="btn btn-shadow btn-success" *ngIf="
          (config.changeEndpoint && identifyDevice()) || landscape()
            ? config.signatureStep
            : true
        " (click)="config.sendSignature(sendFormButton)">
        {{ 'approve' | translate: { Default: 'Approve' } }}
        <app-spinner *ngIf="saveProcess"></app-spinner>
      </button>

      <button type="button" class="btn btn-shadow btn-primary next-button" *ngIf="
          (config.changeEndpoint && identifyDevice()) || landscape()
            ? !config.signatureStep
            : false
        " (click)="config.signatureStep = true">
        {{ 'next' | translate: { Default: 'Next' } }}
        <svg class="ml-1" width="16" height="11" viewBox="0 0 16 11" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M11.1816 10.5377C11.0345 10.5377 10.8138 10.5377 10.7402 10.3906C10.5195 10.1699 10.5195 9.80213 10.7402 9.58144L14.639 5.68265C14.8597 5.46196 14.8597 5.09415 14.639 4.87346L10.7402 0.974695C10.5195 0.754009 10.5195 0.386195 10.7402 0.16551C10.9609 -0.0551759 11.3287 -0.0551759 11.5494 0.16551L15.4482 4.0643C16.1838 4.79992 16.1838 5.82978 15.4482 6.5654L11.5494 10.4642C11.5494 10.5377 11.4023 10.5377 11.1816 10.5377Z"
            fill="white" />
          <path
            d="M14.7124 5.82983H0.588497C0.220688 5.82983 0 5.60913 0 5.24132C0 4.87351 0.220688 4.65283 0.588497 4.65283H14.7124C15.0802 4.65283 15.3009 4.87351 15.3009 5.24132C15.3009 5.60913 15.0802 5.82983 14.7124 5.82983Z"
            fill="white" />
        </svg>
      </button>
    </div>
  </div>
</div>

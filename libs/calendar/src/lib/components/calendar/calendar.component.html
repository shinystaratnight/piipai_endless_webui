<div class="widget">

  <div class="widget-header calendar-header">
    <h3 class="widget-name">Calendar</h3>

    <div *ngIf="calendarType !== 2" class="btn-group range-buttons" btnRadioGroup [formControl]="currentRange">
      <label [btnRadio]="range.Month" role="button"  [class.active]="isMonthRange">Month</label>
      <label [btnRadio]="range.Week" role="button"  [class.active]="isWeekRange">Week</label>
      <label [btnRadio]="range.Day" role="button"  [class.active]="isDayRange">Day</label>
    </div>

    <div class="range-title-wrapper">
      <button type="button" class="prev" (click)="changeRange(false)">
        <fa-icon [icon]="['fas', 'chevron-left']"></fa-icon>
      </button>

      <button type="button" class="next" (click)="changeRange(true)">
        <fa-icon [icon]="['fas', 'chevron-right']"></fa-icon>
      </button>

      <span class="range-title" (click)="openDropdown()">{{rangeTitle}}</span>

      <fa-icon class="px-2" [icon]="['fas', 'chevron-down']"></fa-icon>

      <app-datepicker *ngIf="showCalendarDropdown" [date]="currentDate" [type]="rangeForDropdown" (update)="setDate($event)" [range]="customRange"></app-datepicker>
    </div>
  </div>

  <div class="widget-body">

    <div class="filters filters-inline">
      <app-filter-related *ngIf="calendarType === 0" (event)="changeQuery($event)" [config]="filters.client"></app-filter-related>
      <app-filter-related *ngIf="calendarType === 0" (event)="changeQuery($event)" [config]="filters.candidate"></app-filter-related>

      <div class="filter-element" #filter>
        <label class="filter-label related">Info layers</label>

        <div class="filter-related">
          <div class="d-flex justify-content-center align-items-center autocomplete-filter" style="position: relative">
            <div class="form-control autocomplete-value"
              (click)="openAutocomplete($event)">
                <div style="overflow: hidden; white-space: nowrap">{{status.displayValue(status.data)}} layers</div>
                <fa-icon [icon]="['fas', status.hideAutocomplete ? 'chevron-down' : 'chevron-up']" class="text-md-white ml-2"></fa-icon>
            </div>

            <div class="autocomplete" [hidden]="status.hideAutocomplete" [ngStyle]="{'top.px': topHeight}">
              <div class="autocomplete-list">
                <ul class="list-group w-100">
                  <li class="list-group-item autocomplete-item form-check" *ngFor="let item of statusFilterData">
                    <ng-container *ngTemplateOutlet="statusItem; context: {type: item.type, label: item.label, className: item.color}"></ng-container>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="calendar noselect">
      <div class="d-flex justify-content-center align-items-center flex-fill" *ngIf="!calendarData">
        <app-loader></app-loader>
      </div>
      <ng-container *ngIf="isMonthRange && calendarData">
        <ng-container *ngTemplateOutlet="monthCalendar"></ng-container>
      </ng-container>

      <ng-container *ngIf="isWeekRange && calendarData">
        <ng-container *ngTemplateOutlet="weekCalendar"></ng-container>
      </ng-container>

      <ng-container *ngIf="isDayRange && calendarData">
        <ng-container *ngTemplateOutlet="dayCalendar"></ng-container>
      </ng-container>

      <footer class="calendar-footer">
        <div class="counters">
          <ng-container *ngFor="let layer of timesheetCounter; let last = last">
            <div class="counter"
              [class.last]="last"
              *ngIf="layer.count || status.data[layer.type]">
                <span class="count" [title]="layer.text + '/' + currentRange.value">
                  <fa-icon [icon]="['fas', calendarType === 2 ? 'file' : 'circle']" [ngClass]="layer.cssClass" [ngStyle]="{fontSize: calendarType === 2 ? '16px' : '8px'}"></fa-icon>
                  {{layer.count}}
                </span><br>
                <span class="count-description">{{layer.text}} / {{currentRange.value}}</span>
            </div>
          </ng-container>
        </div>

        <ng-container *ngIf="isManager() && hasSelectedDates && calendarData">
          <span class="f-size-12 hov-opacity ml-auto" (click)="clearSelectedDates()">Reset selected dates</span>

          <button type="button" class="btn job-btn ml-3" (click)="addJob()">Create Job</button>
        </ng-container>
      </footer>
    </div>
  </div>

</div>

<ng-template #statusItem let-type="type" let-display="label" let-className="className">
    <label class="d-flex align-items-center">
      <input
        type="checkbox"
        class="form-check-input"
        [(ngModel)]="status.data[type]"
        (ngModelChange)="updateLayers()"
        hidden>
      <div [ngClass]="className + ' custom-checkbox'">
        <svg width="9" height="7" viewBox="0 0 9 7" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.08284 4.87574C2.92663 5.03195 2.67337 5.03195 2.51716 4.87574L1.12071 3.47929C0.888359 3.24694 0.511641 3.24694 0.279289 3.47929C0.0469372 3.71164 0.0469373 4.08836 0.279289 4.32071L2.37574 6.41716C2.61005 6.65147 2.98995 6.65147 3.22426 6.41716L8.52071 1.12071C8.75306 0.888359 8.75306 0.511642 8.52071 0.279289C8.28836 0.0469374 7.91164 0.0469372 7.67929 0.279289L3.08284 4.87574Z" fill="white" stroke="#FDFDFD" stroke-width="0.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      {{display}}
    </label>
  </ng-template>

<ng-template #monthCalendar>
  <div class="grid-row">
    <span class="grid-item header-item" *ngFor="let day of calendarData?.header">{{day}}</span>
  </div>
  <div class="grid-row" *ngFor="let week of calendarData?.body">
    <ng-container *ngFor="let day of week; let i = index">
      <span class="grid-item month-day"
        [class.date-selected]="isSelected(day.date)"
        *ngIf="!day.tooltip && calendarType !== 2"
        appSelectDate
        [disable]="!isManager()"
        [date]="day.date">
          <span class="date" [class.current-date]="day.today">{{day.label}}</span>
      </span>

      <span class="grid-item month-day"
        [class.available]="day.available === true"
        [class.unavailable]="day.available === false"
        triggers="click:click"
        [ngbTooltip]="availabilityTooltip"
        [placement]="getPlacement(i, week.length)"
        *ngIf="!day.tooltip && calendarType === 2">
          <span class="date" [class.current-date]="day.today">{{day.label}}</span>

          <ng-template #availabilityTooltip>
            <div class="shift-tooltip">
              <h5 class="text-center">{{ day.availableId ? 'Update' : 'Confirm?'}}</h5>
              <div class="d-flex align-items-center justify-content-between">
                <button type="button" class="btn btn-sm btn-primary mr-auto" (click)="setAvailability($event, day, true)">Available</button>
                <button type="button" class="btn btn-sm btn-primary" (click)="setAvailability($event, day, false)">Unavailable</button>
              </div>
            </div>
          </ng-template>
      </span>

      <span class="grid-item month-day"
        [class.date-selected]="isSelected(day.date)"
        appSelectDate
        [date]="day.date"
        [disable]="!isManager()"
        *ngIf="day.tooltip"
        [class.active]="day.isOpen"
        triggers="click:click"
        [ngbTooltip]="monthTooltip"
        [placement]="getPlacement(i, week.length)"
        (shown)="day.isOpen = true"
        (hidden)="day.isOpen = false">

        <span class="date" [class.current-date]="day.today">{{day.label}}</span>

        <div class="shift-groups">
          <div *ngIf="day.tooltip[1].length" class="badge badge-success">{{getShiftCount(day.tooltip[1], 'accepted')}}</div>
          <div *ngIf="day.tooltip[0].length" class="badge badge-danger">{{day.tooltip[0].length}}</div>
          <div *ngIf="day.tooltip[2].length" class="badge badge-warning">{{getShiftCount(day.tooltip[2], 'undefined')}}</div>
          <div *ngIf="day.tooltip[3].length"><fa-icon [icon]="['fas', 'file']" class="text-primary"></fa-icon></div>
          <div *ngIf="day.tooltip[4].length"><fa-icon [icon]="['fas', 'file']" class="text-warning"></fa-icon></div>
          <div *ngIf="day.tooltip[5].length"><fa-icon [icon]="['fas', 'file']" class="text-success"></fa-icon></div>

          <fa-icon [icon]="['fas', 'envelope']" class="text-secondary" *ngIf="day.jobOffers && day.jobOffers.length"></fa-icon>
        </div>

        <ng-template #monthTooltip>
          <div class="shift-tooltip">
            <ng-container *ngTemplateOutlet="shiftGroup; context: {shifts: day.tooltip[1], className: 'success', name: 'Fulfilled', status: 'accepted', month: true}"></ng-container>
            <ng-container *ngTemplateOutlet="shiftGroup; context: {shifts: day.tooltip[0], className: 'danger', name: 'Unfulfilled', status: 'cancelled', month: true}"></ng-container>
            <ng-container *ngTemplateOutlet="shiftGroup; context: {shifts: day.tooltip[2], className: 'warning', name: 'Pending', status: 'undefined', month: true}"></ng-container>
            <ng-container *ngTemplateOutlet="shiftGroup; context: {shifts: day.tooltip[3], className: 'primary', name: 'Open', month: true}"></ng-container>
            <ng-container *ngTemplateOutlet="shiftGroup; context: {shifts: day.tooltip[4], className: 'warning', name: 'Filled', month: true}"></ng-container>
            <ng-container *ngTemplateOutlet="shiftGroup; context: {shifts: day.tooltip[5], className: 'success', name: 'Approved', month: true}"></ng-container>
          </div>

          <div *ngIf="day.jobOffers && day.jobOffers.length">
            <ng-container *ngFor="let jobOffer of day.jobOffers">
              <div class="shift-name flex-column align-items-start text-left">
                <span class="p-1 mb-2 rounded bg-secondary">Start - {{jobOffer.time}}</span>

                <ng-container *ngTemplateOutlet="shiftItem; context: { shift: jobOffer }"></ng-container>
                <div class="d-flex align-items-center mt-1 mb-2">
                  <button type="button" class="d-flex align-items-center btn btn-success btn-sm px-2 mr-2 text-white" (click)="acceptJobOffer(jobOffer.jobOffer.id)">
                    <fa-icon [icon]="['fas', 'check-circle']" class="mr-1 p-0"></fa-icon>Accept
                  </button>

                  <button type="button" class="d-flex align-items-center btn btn-danger btn-sm px-2 text-white" (click)="declineJobOffer(jobOffer.jobOffer.id)">
                    <fa-icon [icon]="['fas', 'times-circle']" class="mr-1 p-0"></fa-icon>Decline
                  </button>
                </div>
              </div>
            </ng-container>
          </div>
        </ng-template>
      </span>
    </ng-container>

  </div>
</ng-template>

<ng-template #weekCalendar>
  <div class="grid-row">
    <div class="times"></div>
    <span class="grid-item header-item" *ngFor="let day of calendarData?.header">{{day}}</span>
  </div>
  <div class="grid-row grid-body">
    <div [ngClass]="['calendar-line', line.class]" [style.top.px]="line.top" *ngFor="let line of calendarData?.body.lines"></div>
    <div class="times">
      <ng-container *ngTemplateOutlet="times"></ng-container>
    </div>
    <span class="grid-item week-item"
      appSelectDate
      [class.date-selected]="isSelected(day.date)"
      [date]="day.date"
      [disable]="!isManager()"
      *ngFor="let day of calendarData?.body">
        <ng-container *ngFor="let shift of day.data; let index = index">
          <div class="shift-item" [class.active]="activeShift === shift.shift.id" appCalendarTooltip [active]="activeShift === shift.shift.id" [ngStyle]="shift.timesheet" [style.margin-left.px]="index * 8" (click)="selectJob($event, shift)">
            <div [ngClass]="['border', getColor(shift.is_fulfilled)]"></div>

            <div class="content">
              <div class="d-flex justify-content-between mr-2">
                <span [ngClass]="['badge', getColor(shift.is_fulfilled)]">Start - {{shift.time}}</span>

                <!-- <span class="badge badge-success" *ngIf="activeShift === shift.shift.id">Fillin</span> -->
              </div>

              <div class="d-flex mr-2">
                <ng-container *ngTemplateOutlet="shiftItem; context: { shift: shift, status: getStatus(shift.is_fulfilled)}"></ng-container>
              </div>
            </div>

          </div>
        </ng-container>
    </span>
  </div>
</ng-template>

<ng-template #times>
  <span class="times-item" [class.time-selected]="isSelectedTime(time.time) && isSelected(calendarData.date)" [style.top.px]="time.top" [style.bottom.px]="time.bottom" *ngFor="let time of calendarTimes" (click)="selectTime(time.time)">{{time.time}}</span>
</ng-template>

<ng-template #dayCalendar>
  <div class="grid-row">
    <div class="times"></div>
    <span class="grid-item header-item" *ngFor="let day of calendarData?.header">{{day}}</span>
  </div>
  <div class="grid-row grid-body">
    <div [ngClass]="['calendar-line', line.class]" [style.top.px]="line.top" *ngFor="let line of calendarData?.body.lines"></div>
    <div class="times">
      <ng-container *ngTemplateOutlet="times"></ng-container>
    </div>
    <span class="grid-item day-item" appSelectDate [class.date-selected]="isSelected(calendarData.date)" [date]="calendarData.date" [disable]="!isManager()">
      <ng-container *ngFor="let shift of calendarData?.body.data; let index = index">
        <div class="shift-item preview" [class.active]="activeShift === shift.shift.id" [active]="activeShift === shift.shift.id" appCalendarTooltip [ngStyle]="shift.timesheet" [style.margin-left.px]="index * 120 + index * 8" (click)="selectJob($event, shift)">
          <div [ngClass]="['border', getColor(shift.is_fulfilled)]"></div>

          <div class="content">
            <div class="d-flex justify-content-between mr-2">
              <span [ngClass]="['badge', getColor(shift.is_fulfilled)]">Start - {{shift.time}}</span>

              <!-- <span class="badge badge-success" *ngIf="activeShift === shift.shift.id">Fillin</span> -->
            </div>

            <div class="d-flex mr-2">
              <ng-container *ngTemplateOutlet="shiftItem; context: { shift: shift, status: getStatus(shift.is_fulfilled)}"></ng-container>
            </div>
          </div>

          <div class="white-shadow"></div>
        </div>
      </ng-container>
      <div class="grid-item" style="min-width: 130px;" [style.margin-left.px]="calendarData?.body.data.length * 120 + calendarData?.body.data.length * 8"></div>
    </span>
  </div>
</ng-template>

<ng-template #shiftGroup let-shifts="shifts" let-className="className" let-name="name" let-status="status">
  <div class="mb-3" *ngIf="shifts.length">
    <p *ngIf="status" class="shift-tooltip-title">
      <span class="mr-1" [ngClass]="'badge badge-' + className">{{status === 'cancelled' ? shifts.length : getShiftCount(shifts, status)}}</span> {{name}}
    </p>

    <div class="shift-name" [class.flex-column]="!status" [class.align-items-start]="!status" *ngFor="let shift of shifts">
      <fa-icon *ngIf="status" [icon]="['fas', 'circle']" [ngClass]="'text-' + className"></fa-icon>

      <span class="p-1 mb-2 rounded" [ngClass]="[getColor(shift.timesheetStatus)]" *ngIf="!status">Start - {{shift.time}}</span>

      <ng-container *ngTemplateOutlet="shiftItem; context: { shift: shift, status: status }"></ng-container>
    </div>
  </div>
</ng-template>

<ng-template #shiftItem let-shift="shift" let-status="status">
  <div>
    <ng-container *ngIf="calendarType === 0">
      <a *ngIf="isManager()" [routerLink]="'/mn' + shift.job_link">{{shift.position}}</a>
      <span *ngIf="!isManager()">{{shift.position}}</span>
    </ng-container>
    <ng-container *ngIf="calendarType !== 0">
      {{shift.position}}
    </ng-container>
    <br>
    <a *ngIf="isManager()" [routerLink]="'/mn' + shift.jobsite_link" class="shift-jobsite">{{shift.jobsite}}</a>
    <span *ngIf="!isManager()" class="shift-jobsite">{{shift.jobsite}}</span> <br>
    <div *ngIf="status && ((shift.candidates[status].length || shift.candidates[getStatus(1)].length))" class="shift-candidates">
      <span class="mr-1">Candidate&nbsp;({{shift.candidates[status].length || shift.candidates[getStatus(1)].length}}):</span>
      <div>
        <div *ngFor="let candidate of shift.candidates[status]">
          <fa-icon *ngIf="getStatus(0) === status" [icon]="['fas', 'times']" class="text-danger"></fa-icon>
          <fa-icon *ngIf="getStatus(1) === status" [icon]="['fas', 'check']" class="text-success"></fa-icon>
          <fa-icon *ngIf="getStatus(2) === status" [icon]="['fas', 'minus-circle']" class="text-warning"></fa-icon>
          <a class="ml-1" *ngIf="isManager()" [routerLink]="getCandidateLink(candidate.id)">{{candidate.name}}</a>
          <span class="ml-1" *ngIf="!isManager()">{{candidate.name}}</span>
        </div>

        <ng-container *ngIf="shift.candidates[getStatus(0)].length && getStatus(0) !== status">
          <div *ngFor="let candidate of shift.candidates[getStatus(0)]">
            <fa-icon [icon]="['fas', 'times']" class="text-danger"></fa-icon>
            <a class="ml-1" *ngIf="isManager()" [routerLink]="getCandidateLink(candidate.id)">{{candidate.name}}</a>
            <span class="ml-1" *ngIf="!isManager()">{{candidate.name}}</span>
          </div>
        </ng-container>

        <ng-container *ngIf="shift.candidates[getStatus(1)].length && getStatus(1) !== status">
          <div *ngFor="let candidate of shift.candidates[getStatus(1)]">
            <fa-icon [icon]="['fas', 'check']" class="text-success"></fa-icon>
            <a class="ml-1" *ngIf="isManager()" [routerLink]="getCandidateLink(candidate.id)">{{candidate.name}}</a>
            <span class="ml-1" *ngIf="!isManager()">{{candidate.name}}</span>
          </div>
        </ng-container>

        <ng-container *ngIf="shift.candidates[getStatus(2)].length && getStatus(2) !== status">
          <div *ngFor="let candidate of shift.candidates[getStatus(2)]">
            <fa-icon [icon]="['fas', 'minus-circle']" class="text-warning"></fa-icon>
            <a class="ml-1" *ngIf="isManager()" [routerLink]="getCandidateLink(candidate.id)">{{candidate.name}}</a>
            <span class="ml-1" *ngIf="!isManager()">{{candidate.name}}</span>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
  <div *ngIf="calendarType === 0" class="shift-action-wrapper">
    <button class="shift-action" type="button" (click)="extendJob(shift)">Extend</button>
    <button class="shift-action" *ngIf="fillinAccess(shift)" type="button" (click)="fillInJob(shift)">Fill in</button>
    <button class="shift-action" [class.bg-success]="activeShift === shift.shift.id" *ngIf="fillinAccess(shift)" type="button" (click)="selectJob($event, shift)">Fill</button>
  </div>
</ng-template>

<ng-template #modal let-modal>
  <div class="modal-content-wrapper">
    <div class="modal-header-wrapper">
      <div class="modal-header">
        <h5 class="modal-title">{{modalInfo.label}}</h5>

        <app-close-button class="ml-auto" (click)="modal.dismiss()"></app-close-button>
      </div>
    </div>
    <div class="modal-body">
      <app-generic-form
        [endpoint]="modalInfo.endpoint"
        [data]="modalInfo.data"
        [mode]="modalInfo.mode"
        [edit]="modalInfo.edit"
        (event)="formEvent($event, modal.close)"
        (errorForm)="formError($event)">
        <div class="text-center">
          <button type="submit" class="btn big-btn btn-shadow btn-primary text-white button-save mt-3 mb-4" [disabled]="saveProcess">
            Save
            <app-spinner *ngIf="saveProcess"></app-spinner>
          </button>
        </div>
      </app-generic-form>
    </div>
  </div>
</ng-template>
